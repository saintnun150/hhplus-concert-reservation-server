## API 흐름 설명서

**대기열 토큰 발급**

- 사용자는 콘서트 예약을 하기 위해 사용자는 `대기열 도메인`을 통해 대기열 토큰을 조회하거나 생성한다.
- 토큰 정보는 `DB`에 저장한다.
- 저장된 정보를 사용자에게 반환한다.


**대기열 토큰 상태 조회**

- 사용자는 `대기열 도메인`을 통해 자신의 대기열 상태를 조회할 수 있다.
- 대기열 토큰을 검증한다.
- 유효하지 않은 토큰일 경우 예외가 발생한다.
- 순번을 체크한다.
- 예약 가능한 상태일 경우 토큰 상태 같은 정보를 갱신한다.
- 순번과 갱신된 정보를 사용자에게 반환한다.


**잔액 조회**

- 사용자는 `사용자 도메인`을 통해 자신의 계좌정보를 조회할 수 있다.
- 사용자 ID를 통해 사용자 유무를 검증한다.
- 유효하지 않은 사용자일 경우 예외가 발생한다.
- 잔액이 포함된 사용자 정보를 반환한다.

**잔액 충전**

- 사용자는 `사용자 도메인`을 통해 자신의 계좌에 잔액을 충전할 수 있다.
- 사용자 ID를 통해 사용자 유무를 검증한다.
- 유효하지 않은 사용자일 경우 예외가 발생한다.
- 잔액에 대한 유효성을 검증한다.
- 유효하지 않을 경우 예외가 발생한다.
- 계좌 정보가 없을 경우 생성한다.
- 계좌에 잔액을 충전한다.
- 잔액이 포함된 사용자 정보를 반환한다.

**예약 가능 콘서트 날짜 조회**

- 사용자는 예약 가능한 날짜를 조회할 수 있다.
- `대기열 도메인`을 통해 자신의 대기열을 검증한 후 `콘서트 도메인`을 통해 필요한 정보를 조회한다.
- 유효하지 않은 대기열일 경우 예외가 발생한다.
- 콘서트 예약 가능 날짜 목록을 반환한다.


**예약 가능 콘서트 좌석 목록 조회**
- 사용자는 예약 가능한 좌석 목록 조회할 수 있다.
- `대기열 도메인`을 통해 자신의 대기열을 검증한 후 `콘서트 도메인`을 통해 필요한 정보를 조회한다.
- 유효하지 않은 대기열일 경우 예외가 발생한다.
- 콘서트 예약 가능 좌석 목록을 반환한다.

**좌석 예약 요청**
- 사용자는 반환된 콘서트 및 좌석 목록을 통해 좌석을 예약할 수 있다.
- `대기열 도메인`을 통해 자신의 대기열을 검증한 후 `콘서트 도메인`을 통해 필요한 정보를 조회한다.
- 유효하지 않은 대기열일 경우 예외가 발생한다.
- 좌석 예약을 요청한다.
- 유효하지 않은 좌석(이미 선점되었거나 좌석 삭제 등)일 경우 예외가 발생한다.
- 예약에 성공할 경우 해당 좌석은 결제 완료 전까지 5분간 사용자에게 우선 배정된다.
- 예약 정보를 저장한다.
- 저장된 정보를 반환한다.


**결제 요청**
- 결제 요청 시, `대기열`, `콘서트`, `사용자`, `결제` 도메인을 통해 프로세스가 진행된다.
- `결제 Application 레이어(facade)`가 중심이 되어 `대기열 검증`, `콘서트 예약 정보 확인`,   
  `계좌 정보 조회 및 검증`, `결제 등록`, `결제 히스토리 저장`, `좌석 상태 변경`, `토큰 만료처리` 등을 수행한다.
- 각 도메인 별로 도메인 정보를 검증하며 유효하지 않을 경우 예외가 발생한다.
- 모든 과정이 성공적으로 완료되면 대기열 토큰을 만료시키고 결제 완료 정보를 사용자에게 반환한다.
